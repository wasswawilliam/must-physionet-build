#!/bin/bash
# Configure virtual machine and run the install-pn-test-server script

set -e

user=
host=localhost
port=10022

################################################################
# Check command-line arguments

if [ $# = 2 ]; then
    repository=$1
    revision=$2
elif [ $# = 1 ]; then
    repository=$(git rev-parse --show-toplevel)
    revision=$1
else
    echo "Usage: $0 [REPOSITORY] REVISION" >&2
    exit 1
fi

################################################################
# Look up the exact commit to be installed

case $repository in
    *:*)
        commit=$(git ls-remote "$repository" "$revision" | cut -f1)
        if [ -n "$commit" ]; then
            echo "Installing $revision ($commit)"
        else
            echo "Installing $revision (TBD)"
            commit=$revision
        fi
        echo "      from $repository"
        echo
        ;;
    *)
        repository=$(readlink -f "$repository")
        commit=$(cd "$repository" &&
                     git rev-parse --quiet --verify "$revision^{commit}") || {
            echo "$revision: not a valid commit in $repository"
            exit 1
        }
        echo "Installing $revision ($commit)"
        echo "      from $repository"
        echo
        ;;
esac

################################################################
# Set up keys so we can connect without a password

tdir=$(mktemp -d)
ttystate=$(stty -g)
cleanup() {
    rm -rf "$tdir"
    stty "$ttystate"
}
trap cleanup EXIT

chmod 700 "$tdir"

keyfile=$tdir/id
ssh-keygen -q -t ed25519 -N '' -f "$keyfile" \
           -C "temporary key generated by $0"

ssh_interactive="ssh -p $port"
ssh="ssh -p $port -o BatchMode=yes -i $keyfile"
scp="scp -P $port -o BatchMode=yes -i $keyfile"
userhost=$user${user:+@}$host
roothost=root@$host

$ssh_interactive -p $port $userhost '
    mkdir -p -m 700 .ssh &&
    tee /tmp/physionet-tmp-id.pub >> .ssh/authorized_keys
' < "$keyfile.pub"

echo "Enter the *root* password for $host:$port below:"

stty -echo
$ssh $userhost "su -c '
    mkdir -p -m 700 /root/.ssh &&
    cat /tmp/physionet-tmp-id.pub >>/root/.ssh/authorized_keys
'"
stty "$ttystate"
echo

################################################################
# Push git repository and run the installation script

case $repository in
    *:*)
        args="$repository $revision $commit"
        ;;
    *)
        tmprepo=/tmp/physionet-tmp.git
        (
            cd "$repository"
            $ssh $roothost "apt-get install -y git"
            $ssh $userhost "git init --bare $tmprepo"
            export GIT_SSH_COMMAND=$ssh
            git push ssh://$userhost$tmprepo "$commit":refs/heads/master
        )
        args="$tmprepo $revision master"
        ;;
esac

$scp install-pn-test-server $roothost:
$ssh $roothost "./install-pn-test-server $args"
$ssh $userhost "rm -rf $tmprepo"

pk=$(cut -d\  -f2 < "$keyfile.pub")
$ssh $userhost "sed \\\\:$pk:d -i .ssh/authorized_keys"
$ssh $roothost "sed \\\\:$pk:d -i .ssh/authorized_keys"
